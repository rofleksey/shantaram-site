---
const userAgent = Astro.request.headers.get('user-agent')?.toLowerCase() || '';
const isMobile = /android|iphone|ipad|ipod|mobile/i.test(userAgent);
---

<div id="background-animation">
  {!isMobile ? (
    <video
      id="bg-video"
      autoplay
      muted
      loop
      playsinline
      preload="none"
      poster="/video/background-poster.jpg"
    >
      <source src="/video/background.webm" type="video/webm">
      <source src="/video/background-hevc.mp4" type="video/mp4; codecs=hvc1">
      <source src="/video/background.mp4" type="video/mp4">
    </video>
  ) : (
    <img
      src="/video/background-poster.jpg"
      alt=""
      id="bg-image"
    />
  )}
</div>

<style>
  #background-animation {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
  }

  #background-animation video,
  #background-animation img {
    position: absolute;
    top: 50%;
    left: 50%;
    min-width: 100%;
    min-height: 100%;
    width: auto;
    height: auto;
    transform: translateX(-50%) translateY(-50%);
    object-fit: cover;
  }
</style>

<script>
  if (typeof window !== 'undefined' && !/Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent)) {
    const handleVideoPlayback = () => {
      const video = document.getElementById('bg-video') as HTMLVideoElement;
      if (!video) {
        return;
      }

      const playVideo = () => {
        if (video.paused) {
          video.play().catch(e => console.log('Video play failed:', e));
        }
      };

      playVideo();

      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          playVideo();
        }
      });
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', handleVideoPlayback);
    } else {
      handleVideoPlayback();
    }
  }
</script>